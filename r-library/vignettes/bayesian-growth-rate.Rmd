---
title: "Bayesian growth rate estimation"
author: "Rob Challen"
date: "22/10/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Bayesian growth rate estimation

Assume, as before $I_t$ is a Poisson distributed quantity, with a rate parameter which is a function of time:


$$
\begin{aligned}
E[I_t] &= \lambda_t \\
\end{aligned}
$$

Assuming $\lambda_t$ is constant over $[t-\tau;t+\tau]$ then by definition:


$$
\begin{aligned}
P(I_{t-\tau},\dots,I_{t+\tau}|\lambda_t) = \prod_{s=t-\tau}^{t+\tau}\frac{e^{-\lambda_t}\lambda_t^{I_s}}{I_s!} \\
\end{aligned}
$$

If we assume $\lambda_t$ to be gamma distributed with shape parameter $\alpha$ and rate parameter $\beta$, and if $n = 2\tau+1$

$$
\begin{aligned}
P(I_{t-\tau},\dots,I_{t+\tau}|\lambda_t) &= \frac{e^{-n\lambda_t}\lambda_t^{\sum{I_s}}}{\prod_{s=t-\tau}^{t+\tau}I_s!} \\

P(\lambda_{t}) &= \frac{\beta^\alpha}{\Gamma(\alpha)} \lambda_{t}^{\alpha-1}e^{-\beta\lambda_{t}} \\

P(\lambda_t|I_{t-\tau},\dots,I_{t+\tau}) &= \frac{P(I_{t-\tau},\dots,I_{t+\tau}|\lambda_t)P(\lambda_{t})}{P(I_{t-\tau},\dots,I_{t+\tau})}\\

P(\lambda_t|I_{t-\tau},\dots,I_{t+\tau}) &= \frac{e^{-n\lambda_t}\lambda_t^{\sum{I_s}}}{\prod_{s=t-\tau}^{t+\tau}I_s!}\frac{\beta^\alpha}{\Gamma(\alpha)} \lambda_{t}^{\alpha-1}e^{-\beta\lambda_{t}}\\

P(\lambda_t|I_{t-\tau},\dots,I_{t+\tau}) &\propto \lambda_t^{\sum{I_s+\alpha-1}}e^{-(2\tau+1+\beta)\lambda_t} \\

P(\lambda_t|I_{t-\tau},\dots,I_{t+\tau}) &\sim \Gamma\big(\sum_{t-\tau}^{t+\tau}{I_s}+\alpha, 2\tau+1+\beta\big)\\
\alpha' &= \alpha+\sum_{t-\tau}^{t+\tau}{I_s}\\
\beta' &= 2\tau+1+\beta
\end{aligned}
$$

The posterior estimate of the Poisson rate $\lambda$ is gamma distributed by definition but to estimate the likely values of $I_t$ ($\overline{I_t}$) we need the posterior predictive distribution:

$$
\begin{aligned}

\overline{I_t} &\sim NegBin\Big(\alpha',\frac{\beta'}{\beta'+1}\Big)\\

E(\overline{I_t}|I_{t-\tau},\dots,I_{t+\tau}) &= \frac{\alpha'}{\beta'} \\

V(\overline{I_t}|I_{t-\tau},\dots,I_{t+\tau}) &= \alpha'\Big(\frac{\beta'+1}{\beta'^2}\Big)
\end{aligned}
$$

The exponential growth rate $r_t$ is the gradient of the logarithm of I ($\frac{d}{dt}log(\overline{I_t})$)

$$
\begin{aligned}
r_t \approx \frac{1}{2m}(log(E(I_{t+m}))-log(E(I_{t-m}))) \\
r_t = \frac{1}{2m}log\frac{\lambda_{t+m}}{\lambda_{t-m}} \\

\end{aligned}
$$
if $m = \tau$ and $\phi_t = e^{2\tau r_t}$

$$
\begin{aligned}
r_t &= \frac{1}{2\tau}log\frac{\lambda_{t+\tau}}{\lambda_{t-\tau}} \\
\phi_t &\sim \Bigg(\frac{Gamma(\alpha+\sum_{s=t}^{t+2\tau}{I_s}, \beta')}{Gamma(\alpha+\sum_{r=t-2\tau}^{t}{I_r}, \beta')}\Bigg) \\

\alpha'_{\tau+} &= \alpha+\sum_{t}^{t+2\tau}{I_s}\\
\alpha'_{\tau-} &= \alpha+\sum_{t-2\tau}^{t}{I_s}\\

\phi_t &\sim \Bigg(\frac{
Gamma(\alpha'_{\tau+}, \beta')
}{
Gamma(\alpha'_{\tau-}, \beta')
}
\Bigg)\\

\end{aligned}
$$

$$
\begin{aligned}
\phi_t \sim BetaPrime\big(\sum_{t}^{t+2\tau}{I}+\alpha, \sum_{t-2\tau}^{t}{I}+\alpha\big) \\

r_t \sim \frac{1}{2\tau}log\Big(BetaPrime\big(\alpha'_{\tau+}, \alpha'_{\tau-})\Big) \\

P(r_t) = \frac{1}{2\tau B(\alpha'_{\tau+}, \alpha'_{\tau-})}
e^{r_t}
\Big(
  e^{r_t(\alpha'_{\tau+}-1)}
  (1+e^{r_t})^{(-\alpha'_{\tau+}-\alpha'_{\tau-})}
\Big)\\

P(r_t) = \frac{1}{2\tau B(\alpha'_{\tau+}, \alpha'_{\tau-})}
\Big(
  e^{r_t(\alpha'_{\tau+})}
  (1+e^{r_t})^{(-\alpha'_{\tau+}-\alpha'_{\tau-})}
\Big)\\

\end{aligned}
$$

Strictly increasing functions:
https://www.statlect.com/fundamentals-of-probability/functions-of-random-variables-and-their-distribution
support for $x$ here is 0,inf as we are looking at ratio of gammas. Support for $r_t$ is -inf,inf.

$$
\begin{aligned}
x &= e^{2\tau r_t}\\
r_t &\sim \frac{1}{2\tau}log(\phi_t)\\
P(r_t) &= P(\phi_t)\frac{d\phi_t}{dr_t}\\
P(r_t) &= P(e^{2\tau r_t})\frac{d}{dr_t}(e^{2\tau r_t})\\
P(r_t) &= 2\tau e^{2\tau r_t}P(e^{2\tau r_t})\\

\end{aligned}
$$

$$
\begin{aligned}

P(r_t) =  \frac{2\tau e^{2\tau r_t}}{B(\alpha'_{\tau+}, \alpha'_{\tau-})}

\Big(
  e^{r_t(\alpha'_{\tau+}-1)}
  (1+e^{r_t})^{(-\alpha'_{\tau+}-\alpha'_{\tau-})}
\Big)\\

P(r_t) =  \frac{2\tau}{B(\alpha'_{\tau+}, \alpha'_{\tau-})}
\Big(
  e^{r_t(\alpha'_{\tau+}+2\tau-1)}
  (1+e^{r_t})^{(-\alpha'_{\tau+}-\alpha'_{\tau-})}
\Big)\\


\end{aligned}
$$




https://en.wikipedia.org/wiki/Beta_prime_distribution#Properties






